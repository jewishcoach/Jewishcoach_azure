name: Deploy Backend to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: jewishcoach-api
  PYTHON_VERSION: '3.10'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Zip backend files for deployment
      run: |
        cd backend
        zip -r ../backend-deploy.zip . \
          -x "*.pyc" \
          -x "*/__pycache__/*" \
          -x "*/antenv/*" \
          -x "tests/*" \
          -x "*.db" \
          -x ".env"
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: backend-deploy.zip
      continue-on-error: false
      
    - name: Verify deployment
      if: success()
      run: |
        echo "‚è≥ Waiting for app to restart..."
        sleep 90
        
        echo "üîç Checking health endpoint..."
        for i in {1..10}; do
          if curl -sf --max-time 15 https://jewishcoach-api.azurewebsites.net/health; then
            echo ""
            echo "‚úÖ Health check passed!"
            exit 0
          fi
          echo "‚ùå Attempt $i/10 failed, waiting 15 seconds..."
          sleep 15
        done
        
        echo "‚ùå Health check failed after 10 attempts"
        echo "‚ö†Ô∏è  Deployment may have issues. Check logs manually."
        exit 1
