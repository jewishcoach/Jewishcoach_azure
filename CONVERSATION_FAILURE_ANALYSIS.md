# ניתוח כשלים – שיחת "זוגיות / שיתוף רגשי"

## השיחה (מהמשתמש)

| # | משתמש | מאמן |
|---|-------|------|
| 1 | כן | מעולה! על מה תרצה להתאמן היום? |
| 2 | זוגיות | על מה בזוגיות תרצה להתאמן? |
| 3 | על שיתוף רגשי | תודה ששיתפת. תוכל לספר לי יותר על מה בדיוק תרצה להתאמן כשאתה מדבר על 'שיתוף רגשי'? |
| 4 | על היכולת לשתף את הרגשות שלי, אני מרגיש חסום | תודה על השיתוף. כשאתה אומר שאתה מרגיש חסום, למה אתה מתכוון בדיוק? מה קורה כשאתה מנסה לשתף את הרגשות שלך? |
| 5 | אני מרגיש נבוך | אני מבין שאתה מרגיש נבוך... תוכל לספר לי יותר על התחושה הזו של המבוכה? מה קורה בדיוק כשאתה מרגיש כך? |
| 6 | אני מתכווץ ולא מרגיש טוב עם זה | תודה על השיתוף... תוכל לספר לי יותר על מה בדיוק קורה כשאתה מרגיש כך? מה עוד קורה במצבים האלה? |
| 7 | באיזה שלב אנחנו? מה בדיוק אנחנו עושים? | (הסבר על התהליך) |
| 8 | אבל אמרתי כבר שאני מתכווץ | **מצטער על החזרה! על מה תרצה להתאמן?** ❌ |

---

## כשלים שזוהו

### 1. לולאת S1 – "תוכל לספר לי יותר" x4
- **תורות 3–6:** המאמן חוזר על "תוכל לספר לי יותר" / "מה בדיוק" / "מה עוד קורה".
- **הבעיה:** הנושא כבר ברור אחרי תור 3–4: "שיתוף רגשי" + "מרגיש חסום" + "מרגיש נבוך" + "מתכווץ".
- **הנחיה ב־s1_topic.md:** "אסור להמשיך לשאול שאלות הבהרה אחרי 2–3 תורות".
- **מה צריך היה:** מעבר ל־S2 (בקשת אירוע ספציפי) אחרי תור 3 או 4.
- **רשת הבטיחות:** `generic_patterns` עם סף 2 אמורה לתפוס – ייתכן שהקוד לא היה מעודכן בפריסה.

### 2. שאלות רגשיות ב־S1 (לפני אירוע)
- **תורות 4–6:** שאלות כמו "מה קורה כשאתה מנסה לשתף", "מה קורה בדיוק כשאתה מרגיש כך", "מה עוד קורה במצבים האלה".
- **הבעיה:** אלו שאלות רגשיות/העמקה לפני שיש אירוע ספציפי. לפי BSD, רגשות שייכים ל־S3, אחרי אירוע ב־S2.
- **רשת הבטיחות:** `emotions_indicators` מחפשת "מה הרגשת" – לא "מה קורה כשאתה מרגיש". יש להרחיב את רשימת האינדיקטורים.

### 3. תגובה שגויה לתסכול – "על מה תרצה להתאמן?"
- **תור 8:** המשתמש: "אבל אמרתי כבר שאני מתכווץ".
- **תגובת המאמן:** "מצטער על החזרה! על מה תרצה להתאמן?" – חזרה ל־S0.
- **הבעיה:** הנושא כבר ברור; התגובה הנכונה היא מעבר ל־S2 (בקשת אירוע), לא איפוס ל"על מה תרצה להתאמן?".
- **סיבה אפשרית:** `has_clear_topic_for_s2` החזיר False, או שה־state לא עודכן נכון (למשל `current_step` נשאר S0).

### 4. בלבול המשתמש – "באיזה שלב אנחנו?"
- **תור 7:** המשתמש מבולבל ושואל "באיזה שלב אנחנו? מה בדיוק אנחנו עושים?"
- **המאמן:** מסביר את התהליך – התנהגות נכונה.
- **הבעיה:** עצם השאלה מעידה על חוויית משתמש גרועה בגלל הלולאה בתורות 3–6.

---

---

## ממצאים מהלוגים (latest_default_docker.log, 17.2)

### 1. State תקוע ב־S0
- כמעט כל התגובות בלוג מציגות `Step: S0` – ה־state כמעט לא מתקדם.
- **סיבה:** ה־LLM מחזיר טקסט רגיל (לא JSON) → `Failed to parse JSON: Expecting value: line 1 column 1`.
- ב־fallback יש S0→S1 רק כש־`msg_count >= 1` – בתור הראשון `msg_count = 0` ולכן נשארים ב־S0.

### 2. באג `'str' object has no attribute 'get'` (תוקן)
```
[BSD V2] Error handling conversation: 'str' object has no attribute 'get'
  File ".../single_agent_coach.py", line 1997, in handle_conversation
    coach_message = parsed.get("coach_message", "") or parsed.get("response", "")
AttributeError: 'str' object has no attribute 'get'
```
- כשהמודל החזיר JSON שהוא מחרוזת (למשל `"text"`), `parsed` היה `str` והקריאה ל־`.get()` גרמה לקריסה.
- **תוקן:** הוספת בדיקה `isinstance(parsed, str)` לפני שימוש ב־`parsed.get()`.

### 3. מקור התגובה "מצטער על החזרה! על מה תרצה להתאמן?"
- המשתמש אמר "אבל אמרתי כבר שאני מתכווץ" → זוהה כ־`user_frustrated`.
- בלוגיקת `user_frustrated`: כש־`current_step == "S0"` נכנסים ל־`else` (לא ל־S1).
- `get_next_step_question("S0")` מחזיר "על מה תרצה להתאמן?".
- **הבעיה:** גם כשיש נושא ברור (שיתוף רגשי, מתכווץ וכו'), מחזירים שאלת S0 במקום לעבור ל־S2.

### 4. שגיאות נוספות בלוג
- `Error extracting V2 insights: 'Conversation' object has no attribute 'updated_at'`
- `Failed to parse JSON` – תדיר, המודל מחזיר טקסט רגיל במקום JSON.

---

## המלצות לתיקון

1. **טיפול ב־user_frustrated כש־current_step == "S0"** – אם יש נושא ברור (לפי `has_clear_topic_for_s2`), לעבור ל־S2 עם שאלת אירוע, לא ל־S1 עם "על מה תרצה להתאמן?".
2. **הרחבת `emotions_indicators`** – להוסיף ביטויים כמו "מה קורה כשאתה מרגיש", "מה עוד קורה במצבים האלה".
3. **החמרת `generic_patterns`** – להוריד את הסף ל־1 או להוסיף דפוסים כמו "למה אתה מתכוון בדיוק", "מה קורה בדיוק".
4. **בדיקת `has_clear_topic_for_s2`** – לוודא שהוא מזהה נושא ברור גם כשיש 4+ הודעות משתמש עם "שיתוף רגשי", "חסום", "נבוך", "מתכווץ".
