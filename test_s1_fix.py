#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Test the S1 frustration handling fix"""

def has_clear_topic_for_s2(messages):
    """Check if topic is clear enough"""
    user_msgs = [m["content"] for m in messages if m["sender"] == "user"]
    
    if len(user_msgs) < 2:
        return False, "need_more_clarification"
    
    total_length = sum(len(m) for m in user_msgs)
    if total_length < 25:
        return False, "too_vague"
    
    detail_words = ["×¨×•×¦×” ×œ", "×œ×”×ª××ž×Ÿ ×¢×œ", "×›×“×™ ×©", "×©××•×›×œ", "×©××“×¢", "×¢×", "×›×©", "×›×œ"]
    all_text = " ".join(user_msgs)
    
    if not any(word in all_text for word in detail_words):
        return False, "missing_context"
    
    return True, ""

print("=" * 80)
print("×ª×¨×—×™×© 1: ×ª×¡×›×•×œ ×‘-S1 ×¢× × ×•×©× ×‘×¨×•×¨")
print("=" * 80)

conv1 = {"messages": [
    {"sender": "coach", "content": "×¢×œ ×ž×” ×ª×¨×¦×™ ×œ×”×ª××ž×Ÿ?"},
    {"sender": "user", "content": "×¢×œ ×©×ž×™×¨×ª ×”×¡×“×¨ ×‘×‘×™×ª"},
    {"sender": "coach", "content": "×œ×ž×” ××ª ×ž×ª×›×•×•× ×ª?"},
    {"sender": "user", "content": "×©××“×¢ ×œ× ×”×œ ××ª ×›×œ ×¢× ×™× ×™ ×”×‘×™×ª ×©×§×©×•×¨×™× ×œ×¡×“×¨ ×•× ×§×™×•×Ÿ"},
    {"sender": "coach", "content": "×¡×¤×¨×™ ×™×•×ª×¨"},
    {"sender": "user", "content": "×¨×•×¦×” ×©×›×œ ×¢×¨×‘ ×œ×¤× ×™ ×©×”×•×œ×›×™× ×œ×™×©×•×Ÿ ×”×‘×™×ª ×ž××•×¨×’×Ÿ"}
]}

print("\nðŸ‘¤ Turn 1: '×¢×œ ×©×ž×™×¨×ª ×”×¡×“×¨ ×‘×‘×™×ª'")
print("ðŸ¤– Turn 2: '×œ×ž×” ××ª ×ž×ª×›×•×•× ×ª?'")
print("ðŸ‘¤ Turn 3: '×©××“×¢ ×œ× ×”×œ ××ª ×›×œ ×¢× ×™× ×™ ×”×‘×™×ª...' (54 ×ª×•×•×™×)")
print("ðŸ¤– Turn 4: '×¡×¤×¨×™ ×™×•×ª×¨'")
print("ðŸ‘¤ Turn 5: '×¨×•×¦×” ×©×›×œ ×¢×¨×‘ ×œ×¤× ×™ ×©×”×•×œ×›×™× ×œ×™×©×•×Ÿ ×”×‘×™×ª ×ž××•×¨×’×Ÿ' (56 ×ª×•×•×™×)")
print("ðŸ¤– Turn 6: '×”×× ×™×© ×ž×©×”×• ×ž×¡×•×™×?'")
print("ðŸ‘¤ Turn 7: '×›×‘×¨ ××ž×¨×ª×™' â† ×ª×¡×›×•×œ!")

conv1["messages"].append({"sender": "user", "content": "×›×‘×¨ ××ž×¨×ª×™"})

has_topic, reason = has_clear_topic_for_s2(conv1["messages"])

print(f"\nðŸ” ×‘×“×™×§×•×ª:")
print(f"   has_clear_topic_for_s2() = {has_topic}")
print(f"   Total length: {sum(len(m['content']) for m in conv1['messages'] if m['sender'] == 'user')} chars")
print(f"   Has detail words: {'×©××“×¢', '×¨×•×¦×”' in ' '.join(m['content'] for m in conv1['messages'] if m['sender'] == 'user')}")

print(f"\nðŸ“‹ ×”×—×œ×˜×”:")
if has_topic:
    print("   âœ… ×™×© × ×•×©× ×‘×¨×•×¨ â†’ ×¢×•×‘×¨ ×œ-S2!")
    print("\nðŸ¤– ×ž××ž×Ÿ:")
    print("   '×× ×™ ×ž×‘×™×Ÿ. ×¡×¤×¨×™ ×œ×™ ×¢×œ ×¤×¢× ××—×ª ×¡×¤×¦×™×¤×™×ª ×©×‘×” ×¨×¦×™×ª")
    print("    ×©×”×‘×™×ª ×™×”×™×” ×ž×¡×•×“×¨ - ×ž×ª×™ ×–×” ×”×™×”?'")
else:
    print(f"   âš ï¸ ×—×¡×¨ × ×•×©× ({reason}) â†’ ×ž×¡×‘×™×¨!")

print("\n" + "=" * 80)
print("×ª×¨×—×™×© 2: ×ª×¡×›×•×œ ×‘-S1 ×œ×œ× × ×•×©× ×‘×¨×•×¨")
print("=" * 80)

conv2 = {"messages": [
    {"sender": "coach", "content": "×¢×œ ×ž×” ×ª×¨×¦×” ×œ×”×ª××ž×Ÿ?"},
    {"sender": "user", "content": "×¢×œ ×©×ž×—×”"},
    {"sender": "coach", "content": "×œ×ž×” ××ª×” ×ž×ª×›×•×•×Ÿ?"},
    {"sender": "user", "content": "×œ×”×™×•×ª ×©×ž×—"}
]}

print("\nðŸ‘¤ Turn 1: '×¢×œ ×©×ž×—×”' (9 ×ª×•×•×™×)")
print("ðŸ¤– Turn 2: '×œ×ž×” ××ª×” ×ž×ª×›×•×•×Ÿ?'")
print("ðŸ‘¤ Turn 3: '×œ×”×™×•×ª ×©×ž×—' (11 ×ª×•×•×™×)")
print("ðŸ¤– Turn 4: '×¡×¤×¨ ×œ×™ ×™×•×ª×¨'")
print("ðŸ‘¤ Turn 5: '×›×‘×¨ ××ž×¨×ª×™' â† ×ª×¡×›×•×œ!")

conv2["messages"].append({"sender": "user", "content": "×›×‘×¨ ××ž×¨×ª×™"})

has_topic, reason = has_clear_topic_for_s2(conv2["messages"])

print(f"\nðŸ” ×‘×“×™×§×•×ª:")
print(f"   has_clear_topic_for_s2() = {has_topic} (reason: {reason})")
print(f"   Total length: {sum(len(m['content']) for m in conv2['messages'] if m['sender'] == 'user')} chars")

print(f"\nðŸ“‹ ×”×—×œ×˜×”:")
if has_topic:
    print("   âœ… ×™×© × ×•×©× ×‘×¨×•×¨ â†’ ×¢×•×‘×¨ ×œ-S2!")
else:
    print(f"   âš ï¸ ×—×¡×¨ × ×•×©× ({reason}) â†’ ×ž×¡×‘×™×¨!")
    print("\nðŸ¤– ×ž××ž×Ÿ ×ž×¡×‘×™×¨:")
    if reason == "too_vague":
        print("   '×× ×™ ×ž×‘×™×Ÿ. ×›×“×™ ×©××•×›×œ ×œ×¢×–×•×¨ ×œ×š ×‘××ž×ª,")
        print("    ×× ×™ ×¦×¨×™×š ×œ×”×‘×™×Ÿ ×™×•×ª×¨ ×œ×¢×•×ž×§ -")
        print("    ×‘××™×–×” ×ž×¦×‘ ××• ×”×§×©×¨ ×”×“×‘×¨ ×”×–×” ×ž×¢×¡×™×§ ××•×ª×š?'")

print("\n" + "=" * 80)
print("ðŸ“Š ×¡×™×›×•×")
print("=" * 80)
print("""
×”×©×•×•××”: ×œ×¤× ×™ ×•××—×¨×™

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ×œ×¤× ×™ ×”×ª×™×§×•×Ÿ âŒ                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ×ª×¡×›×•×œ ×‘-S1 â†’ "×ž×¦×˜×¢×¨! ×¢×œ ×ž×” ×ª×¨×¦×” ×œ×”×ª××ž×Ÿ?" (×—×–×¨ ×œ-S0!)        â”‚
â”‚ ×ª×•×¦××”: ×ž×©×ª×ž×© ×ž×ª×•×¡×›×œ ×¢×•×“ ×™×•×ª×¨!                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ××—×¨×™ ×”×ª×™×§×•×Ÿ âœ…                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ×ª×¡×›×•×œ ×‘-S1 + × ×•×©× ×‘×¨×•×¨:                                       â”‚
â”‚   â†’ "×× ×™ ×ž×‘×™×Ÿ. ×¡×¤×¨ ×œ×™ ×¢×œ ×¤×¢× ×¡×¤×¦×™×¤×™×ª..." (×¢×•×‘×¨ ×œ-S2!)        â”‚
â”‚                                                                â”‚
â”‚ ×ª×¡×›×•×œ ×‘-S1 + × ×•×©× ×œ× ×‘×¨×•×¨:                                    â”‚
â”‚   â†’ "×× ×™ ×ž×‘×™×Ÿ. ×”×¡×™×‘×” ×©×× ×™ ×©×•××œ ×”×™×..." (×ž×¡×‘×™×¨!)               â”‚
â”‚                                                                â”‚
â”‚ ×ª×•×¦××”: ×ž×©×ª×ž×© ×ž×‘×™×Ÿ + × ×•×ª×Ÿ ×ž×™×“×¢ ××™×›×•×ª×™!                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

×”×¢×™×§×¨×•×Ÿ:
â€¢ ×ª×¡×›×•×œ = SIGNAL, ×œ× COMMAND
â€¢ ×ª×ž×™×“ ×‘×•×“×§×™× ×× ×™×© ×ž×¡×¤×™×§ ×ž×™×“×¢
â€¢ ×× ×—×¡×¨ â†’ ×ž×¡×‘×™×¨×™× ×œ×ž×” ×–×” ×—×©×•×‘
""")

print("\nâœ… ×¡×™×ž×•×œ×¦×™×” ×”×•×©×œ×ž×”!")
