# 📋 תכנית שיפור: הנחיות ברורות + Gates גמישים

**מטרה:** לפתור שתי בעיות מרכזיות:
1. ❌ המשתמש לא מבין מה נדרש ממנו
2. ❌ המערכת לא מזהה שהמשתמש השלים את הנדרש

---

## 🔍 ניתוח הבעיות

### בעיה #1: הנחיות לא ברורות מספיק

| שלב | הנחיה נוכחית | מה חסר |
|-----|--------------|---------|
| **S2** (אירוע) | "תן דוגמה לאירוע ספציפי שקרה לאחרונה" | ❌ אין דוגמה<br>❌ לא ברור מה זה "ספציפי"<br>❌ אין מבנה (מה+מי+איפה+מתי) |
| **S3** (רגשות) | "אילו רגשות התעוררו בך? ספר לפחות ארבעה" | ❌ אין דוגמאות לרגשות<br>❌ לא מוסבר ההבדל בין רגש למחשבה/פעולה |
| **S4** (מחשבה) | "מה הייתה המחשבה המילולית שעברה בך?" | ❌ אין דוגמה<br>❌ לא מוסבר ההבדל בין מחשבה לפעולה |
| **S5** (מעשה) | "מה עשית בפועל באותה סיטואציה?" | ❌ אין דוגמה<br>❌ לא מוסבר שזו פעולה קונקרטית |

### בעיה #2: Gates מחמירים מדי

| שלב | דרישה נוכחית | בעיה | פתרון מוצע |
|-----|--------------|-------|-------------|
| **S2** | `detect_action_sequence()` + `detect_other_people()` | מחמיר מדי - רק פעלים ספציפיים | ✅ לקבל אם יש: 10+ מילים + אזכור אנשים |
| **S3** | >= 4 רגשות | המתודולוגיה אומרת 3-4, לא 4+ | ✅ להנמיך ל-**3 רגשות** |
| **S4** | משפט (לא רגש בודד) | סביר | ✓ אין שינוי |
| **S5** | actual + desired | סביר | ✓ אין שינוי |

---

## 💡 פתרונות מוצעים

### פתרון #1: שיפור ההנחיות (Scripts + Loop Prompts)

#### S2 (אירוע) - לפני:
```python
"S2": (
    "כדי לעבוד בצורה מדויקת, נביא רגע אחד מהחיים.\n"
    "תן/י דוגמה לאירוע ספציפי שקרה לאחרונה, שבו התעורר בך רגש חזק והיו מעורבים בו אנשים נוספים."
),
```

#### S2 (אירוע) - אחרי:
```python
"S2": (
    "כדי לעבוד בצורה מדויקת, נביא רגע אחד מהחיים.\n\n"
    "תאר/י אירוע ספציפי שקרה לאחרונה:\n"
    "• **מה קרה?** (הסיטואציה)\n"
    "• **עם מי?** (אנשים מעורבים)\n"
    "• **מתי ואיפה?** (זמן ומקום)\n\n"
    "**דוגמה:** \"אתמול בערב ביקשתי מהילד שלי לעשות שיעורים, הוא סירב, צעקתי עליו, והוא הלך לחדר שלו.\""
),
```

**שינויים:**
- ✅ מבנה ברור (bullet points)
- ✅ דוגמה קונקרטית
- ✅ הדגשה על מה חשוב (מה קרה + עם מי)

---

#### S3 (רגשות) - לפני:
```python
"S3": (
    "עכשיו נעשה סדר בחוויה, כדי לראות אותה בבהירות.\n"
    "נתחיל במסך הרגש:\n"
    "אילו רגשות התעוררו בך באותו רגע? ספר/י לפחות ארבעה."
),
```

#### S3 (רגשות) - אחרי:
```python
"S3": (
    "עכשיו נעשה סדר בחוויה, כדי לראות אותה בבהירות.\n"
    "נתחיל במסך הרגש:\n\n"
    "אילו **רגשות** התעוררו בך באותו רגע?\n"
    "(צריך לפחות 3-4 רגשות)\n\n"
    "**רגש = תחושה פנימית:**\n"
    "כעס, תסכול, בושה, פחד, עצב, שמחה, קנאה, אשמה, בדידות\n\n"
    "⚠️ **לא רגש:**\n"
    "❌ פעולות: \"צעקתי\", \"בכיתי\", \"ברחתי\"\n"
    "❌ מחשבות: \"אני כישלון\", \"הוא לא טוב\"\n"
    "❌ מטרות: \"רוצה להיות טוב יותר\""
),
```

**שינויים:**
- ✅ הנמכה ל-**3-4 רגשות** (במקום 4+)
- ✅ דוגמאות לרגשות תקינים
- ✅ הסבר מפורש מה **אינו** רגש (פעולות, מחשבות, מטרות)

---

#### S4 (מחשבה) - לפני:
```python
"S4": (
    "מאחורי הרגש יש בדרך כלל משפט פנימי.\n"
    "מה הייתה המחשבה המילולית שעברה בך באותו רגע? משפט אחד."
),
```

#### S4 (מחשבה) - אחרי:
```python
"S4": (
    "מאחורי הרגש יש בדרך כלל משפט פנימי.\n\n"
    "מה **המחשבה** שעברה בך באותו רגע?\n"
    "(משפט אחד שחשבת בראש)\n\n"
    "**דוגמאות:**\n"
    "✓ \"אני אב רע\"\n"
    "✓ \"הוא לא מכבד אותי\"\n"
    "✓ \"אני לא מספיק טוב\"\n\n"
    "⚠️ **לא מחשבה:**\n"
    "❌ פעולות: \"צעקתי עליו\", \"הלכתי לחדר\"\n"
    "❌ רגשות: \"כעס\", \"תסכול\""
),
```

**שינויים:**
- ✅ דוגמאות קונקרטיות למחשבות
- ✅ הבהרה שזה משפט בראש, לא פעולה

---

#### S5 (מעשה) - לפני:
```python
"S5": (
    "עכשיו נישאר בעובדות בלבד.\n"
    "מה עשית בפועל באותה סיטואציה? בלי הסברים ובלי פרשנות."
),
```

#### S5 (מעשה) - אחרי:
```python
"S5": (
    "עכשיו נישאר בעובדות בלבד.\n\n"
    "מה **עשית בפועל** באותה סיטואציה?\n"
    "(פעולה קונקרטית שעשית, בלי הסברים)\n\n"
    "**דוגמאות:**\n"
    "✓ \"צעקתי עליו ואמרתי לו ללכת לחדר\"\n"
    "✓ \"הלכתי לחדר אחר ושתקתי\"\n"
    "✓ \"אמרתי לה שהיא תמיד מתלוננת\"\n\n"
    "⚠️ **לא פעולה:**\n"
    "❌ רגשות: \"הייתי כועס\", \"הרגשתי רע\"\n"
    "❌ מחשבות: \"חשבתי שהוא לא מכבד\""
),
```

**שינויים:**
- ✅ דוגמאות קונקרטיות לפעולות
- ✅ הבהרה שזו פעולה חיצונית, לא רגש/מחשבה

---

### פתרון #2: הקלה ב-Gates

#### S2 Gate - שינויים:
```python
# לפני:
has_event = detect_action_sequence(text)  # רק פעלים ספציפיים
has_people = detect_other_people(text)
if has_event and has_people:
    return True, ...

# אחרי:
has_event = detect_action_sequence(text)  # פעלים ספציפיים
has_people = detect_other_people(text)
is_long_enough = len(text.split()) >= 10  # 10+ מילים

# גמיש: אם יש פעלים + אנשים ← מקובל
# או: אם יש אנשים + תיאור ארוך ← גם מקובל
if (has_event and has_people) or (has_people and is_long_enough):
    return True, ...
```

**הסבר:**  
במקום לדרוש **רק** פעלים ספציפיים, נקבל גם תיאורים ארוכים שמזכירים אנשים (10+ מילים). זה מאפשר למשתמש לתאר אירוע בצורה טבעית.

---

#### S3 Gate - שינויים:
```python
# לפני:
if len(merged) >= 4:
    return True, ...

# אחרי:
if len(merged) >= 3:  # הנמכה מ-4 ל-3
    return True, ...
```

**הסבר:**  
המתודולוגיה של BSD מבקשת 3-4 רגשות, לא בהכרח 4+. הנמכה ל-3 תאפשר זרימה טבעית יותר.

---

## 📊 השפעה צפויה

### לפני השיפורים:
- ⚠️ **תקיעות:** משתמשים תקועים 5-7 סיבובים ב-S2/S3
- ⚠️ **בלבול:** משתמשים לא מבינים ההבדל בין רגש/מחשבה/פעולה
- ⚠️ **תסכול:** "מה עוד אתה רוצה ממני??"

### אחרי השיפורים:
- ✅ **זרימה חלקה:** 2-3 סיבובים בכל שלב (במקום 5-7)
- ✅ **בהירות:** דוגמאות קונקרטיות + הסברים מפורשים
- ✅ **פחות תסכול:** המשתמש יודע בדיוק מה נדרש

---

## 🎯 סדר יישום

### שלב 1: שיפור Scripts (עדיפות גבוהה)
- [x] S2: הוספת מבנה + דוגמה
- [x] S3: הוספת דוגמאות רגשות + הבהרת "לא רגש"
- [x] S4: הוספת דוגמאות מחשבות
- [x] S5: הוספת דוגמאות פעולות

**קובץ:** `backend/app/bsd/scripts.py`

### שלב 2: הקלה ב-Gates (עדיפות גבוהה)
- [x] S2: גמישות - קבלת תיאור ארוך (10+ מילים) + אנשים
- [x] S3: הנמכה ל-3 רגשות

**קובץ:** `backend/app/bsd/stage_gates.py`

### שלב 3: שיפור Loop Prompts (עדיפות בינונית)
- [ ] S2: הוספת תזכורת למבנה
- [ ] S3: הוספת דוגמאות בloop
- [ ] S4: הוספת דוגמה בloop
- [ ] S5: הוספת דוגמה בloop

**קובץ:** `backend/app/bsd/scripts.py` (LOOP_PROMPTS_HE)

### שלב 4: בדיקה עם סימולטור (עדיפות גבוהה)
- [ ] הרצת `test_mcuy_quick.py`
- [ ] וידוא שהתיקונים עובדים
- [ ] השוואה: לפני vs אחרי

---

## ✅ קריטריונים להצלחה

1. **פחות לופים:**
   - S2: ממוצע 2-3 סיבובים (במקום 5+)
   - S3: ממוצע 2-3 סיבובים (במקום 4+)

2. **פחות כשלים:**
   - 0 משתמשים תקועים ב-S2/S3
   - 90%+ מגיעים ל-S4/S5

3. **משוב מהסימולטור:**
   - תרחיש "משתמש רגיל" → מגיע ל-S5 ב-7-10 סיבובים
   - תרחיש "לא מבין רגשות" → מקבל הדרכה ברורה ומתקדם

---

## 📁 קבצים לעריכה

1. **`backend/app/bsd/scripts.py`**
   - שורות 93-143: SCRIPTS_HE
   - שורות 204-216: LOOP_PROMPTS_HE

2. **`backend/app/bsd/stage_gates.py`**
   - שורה 234: `check_s2_gate`
   - שורה 311: `check_s3_gate`

3. **`backend/test_mcuy_quick.py`**
   - הרצה לבדיקה

