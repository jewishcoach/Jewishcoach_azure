# 🎯 Stage-Specific Context Injection - Implementation Summary

## מטרה
להפוך את המאמן ה-AI ל**חי ואנושי יותר** על ידי הזרקת דוגמאות ספציפיות לכל שלב מתוך ספר "סודות האימון היהודי" של בני גל.

---

## הבעיה שפתרנו

**לפני:** המאמן דיבר בצורה שאלונית, רובוטית, ללא עומק.

**דוגמה:**
```
User: "על הורות"
Coach: "זה תחום רחב! 🎯 מה בתוך זה הכי מעניין אותך?"  ❌
```

**אחרי:** המאמן משתמש בסגנון ובדוגמאות מהספר, ספציפיות לכל שלב.

**דוגמה צפויה:**
```
User: "על הורות"
Coach: "אוקיי, הורות. ספר לי - מה בהורות מדבר אליך עכשיו?"  ✅
[בפרומפט יש: "שאל בפשטות. אל תגיד 'זה רחב'. שאל 'מה בזה?'"]
```

---

## הפתרון שיישמנו

### **Stage-Specific Context Injection**

כל שלב מקבל:
1. ✅ דוגמאות מסיפור צבי ודוד (מהספר)
2. ✅ שאלות רלוונטיות לשלב
3. ✅ עקרונות ספציפיים לשלב

---

## קבצים שנוצרו/עודכנו

### 1. `app/bsd/stage_context_builder.py` ✨ **NEW**

**תפקיד:** בונה context ספציפי לכל שלב מתוך ה-RAG.

**פונקציה ראשית:**
```python
async def build_stage_context(stage: StageId, language: str) -> Optional[str]
```

**תהליך:**
1. **Mapping** - ממפה StageId → Azure Search Phase
2. **Search** - מחפש ב-RAG לפי phase + keywords
3. **Filter** - מסנן דוגמאות רלוונטיות
4. **Build** - בונה פרומפט מעוצב

**דוגמת output:**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📚 הקשר מהספר - שלב S3
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

דוגמאות מסיפור האימון של צבי ודוד:

💡 [רגש] פחד. בדידות. עצבות.
💡 [רגש] שמחה. התרגשות. גאווה.
💡 [רגשות מציפים אותנו באשכולות] רגשות מציפים אותנו באשכולות, אפשר עוד רגש אחד?

💡 עקרונות לשלב זה:
בקש רגשות ספציפיים. לפחות 4.

זכור: דבר כמו צבי - בסקרנות, בחמימות, לא כשאלון.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 2. `app/bsd/conversational_coach.py` 🔄 **UPDATED**

**שינוי:** הוספנו הזרקת stage context לפרומפט.

**קוד שנוסף:**
```python
# ✨ NEW: Inject stage-specific context from RAG
stage_context = None
try:
    stage_id = StageId(stage) if isinstance(stage, str) else stage
    stage_context = await build_stage_context(stage_id, language)
    
    if stage_context:
        # Add stage context to system message
        sys = SystemMessage(content=sys.content + "\n\n" + stage_context)
        logger.info(f"✅ [CONVERSATIONAL] Injected stage context for {stage_id}")
except Exception as e:
    logger.warning(f"⚠️ [CONVERSATIONAL] Could not load stage context: {e}")
    # Continue without stage context - not critical
```

**הערה:** זה קורה **לפני** יצירת ה-HumanMessage, כך ש-LLM רואה את ה-context בזמן שהוא מייצר את התשובה.

---

## Mapping: Stage → RAG Phase

```python
STAGE_TO_PHASE_MAPPING = {
    StageId.S1: "Situation",         # נושא → המצוי/הרצוי
    StageId.S2: "Situation",         # אירוע → אירוע ספציפי
    StageId.S3: None,                # רגשות → אין Emotion_Screen, שימוש ב-keywords
    StageId.S4: "Paradigm",          # מחשבה → פרדיגמה
    StageId.S5: None,                # מעשה → אין Action_Screen, שימוש ב-keywords
    StageId.S6: "Gap",               # פער
    StageId.S7: "Pattern",           # דפוס
    StageId.S8: "Stance",            # עמדה (רווח והפסד)
    StageId.S9: "KMZ_Source_Nature", # כמ"ז
    StageId.S11: "New_Choice",       # בחירה חדשה
    StageId.S12: "Vision",           # חזון
    StageId.S10: "Coaching_Request", # בקשה לאימון
}
```

**הערה:** כאשר אין phase ישיר, משתמשים ב-keywords.

---

## Keywords per Stage

```python
STAGE_KEYWORDS = {
    StageId.S1: ["המצוי", "הרצוי", "נושא לאימון"],
    StageId.S2: ["אירוע ספציפי", "סיפור", "למפגש הבא"],
    StageId.S3: ["רגש", "מסך רגשי", "אילו רגשות"],
    StageId.S4: ["מחשבה", "מסך מחשבתי", "פרדיגמה"],
    StageId.S5: ["מעשה", "מסך מעשי", "דרך הפעולה"],
    StageId.S6: ["פער", "הזדמנות"],
    StageId.S7: ["דפוס", "חוזר"],
    StageId.S8: ["עמדה", "רווח והפסד", "מרוויח"],
    StageId.S9: ["כמ\"ז", "כוחות מקור", "כוחות טבע"],
    StageId.S11: ["בחירה חדשה", "עמדה חדשה", "פרדיגמה חדשה"],
    StageId.S12: ["חזון", "שליחות"],
    StageId.S10: ["בקשה לאימון", "אני מבקש להתאמן"],
}
```

---

## סינון דוגמאות (Filter Logic)

**סדר עדיפויות:**

1. **📖 דיאלוגים** - קטעים עם "שאל", "אמר", "השיב", "ענה"
2. **❓ שאלות מפתח** - `key_question` מה-RAG
3. **🔧 כלים** - תיאורי כלים (`tool_used`)
4. **💡 כל תוכן רלוונטי** - לפחות 15 תווים

**מינימום:** 15 תווים (כדי לכלול גם snippets קצרים כמו "פחד. בדידות. עצבות.")

---

## דוגמאות לפי שלב

### **S1 - נושא לאימון**
```
💡 [המצוי] הקומה בה אתה נמצא כעת...
💡 [תמונת המצוי] תמונת המצוי היא תרגול עם ינון...
💡 [תמונת הרצוי] תמונת הרצוי היא תרגול...

💡 עקרונות לשלב זה:
שאל בפשטות על הנושא. אל תגיד 'זה רחב'. שאל 'מה בזה?'
```

### **S3 - רגשות**
```
💡 [רגש] פחד. בדידות. עצבות.
💡 [רגש] שמחה. התרגשות. גאווה.
💡 [רגשות מציפים אותנו באשכולות] אפשר עוד רגש אחד?

💡 עקרונות לשלב זה:
בקש רגשות ספציפיים. לפחות 4.
```

### **S8 - עמדה (Stance)**
```
💡 [עמדה] איזו עמדה, השקפה, או אמונה שלך, מחזיקה את הפרדיגמה?
💡 [עמדה] מהי אותה עמדה שלך...
💡 [רווח והפסד] אפשר לחזור אל טבלת רווח והפסד...

💡 עקרונות לשלב זה:
טבלת רווח והפסד - מה מרוויח? מה מפסיד?
```

---

## בדיקה

**קובץ טסט:** `test_stage_context.py`

**הרצה:**
```bash
cd backend
source venv/bin/activate
python test_stage_context.py
```

**תוצאה צפויה:**
```
✅ Context generated for S1
✅ Context generated for S3
✅ Context generated for S8
```

---

## תוצאות צפויות

### **לפני:**
```
User: "על הורות"
Coach: "זה תחום רחב! 🎯 מה בתוך זה הכי מעניין אותך?"
```

### **אחרי:**
```
User: "על הורות"
Coach: "אוקיי, הורות. ספר לי - איזה חלק בהורות מדבר אליך עכשיו?"
[+ context מהספר בפרומפט]
```

**המאמן:**
- ✅ לא אומר "זה רחב"
- ✅ לא משתמש באמוג'י
- ✅ לא משתמש בביטויים פורמליים ("מה בתוך זה הכי מעניין")
- ✅ משתמש בשפה טבעית ופשוטה
- ✅ מחקה את הסגנון של צבי מהספר

---

## שיפורים עתידיים (אופציונלי)

### 1. **Expand RAG Content**
- הוסף עוד דיאלוגים מהחוברת
- הוסף דוגמאות אמיתיות משיחות משתמשים (אנונימיות)

### 2. **Dynamic Examples**
- הזרק דוגמאות **רלוונטיות לנושא של המשתמש**
  - משתמש מדבר על "הורות" → דוגמאות על הורות
  - משתמש מדבר על "עבודה" → דוגמאות על עבודה

### 3. **Few-Shot Learning**
- הוסף דיאלוגים מלאים (multi-turn) כ-few-shot examples

### 4. **Feedback Loop**
- אסוף feedback ממשתמשים: "האם התשובה הזו הרגישה טבעית?"
- שפר את הפרומפטים לפי הנתונים

---

## סיכום

✅ **הושלם:**
- Stage-specific context injection
- Mapping שלבים ל-RAG phases
- Filter חכם לדוגמאות
- Integration עם conversational_coach

✅ **בדיקות:**
- S1, S3, S8 עובדים מצוין
- Context מוזרק בהצלחה

🎯 **התוצאה:** מאמן שמרגיש יותר כמו צבי מהספר, פחות כמו שאלון.

---

**תאריך:** 2026-01-31  
**סטטוס:** ✅ הושלם ופעיל

