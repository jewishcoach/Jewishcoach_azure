# 🎯 Few-Shot Architecture - Complete Redesign

## מטרה
להפוך את המאמן ה-AI מ-**רובוט טכני** ל-**מאמן חי** כמו צבי מהספר של בני גל.

---

## 🔍 הבעיה שזיהינו

### לפני השינוי:

```python
# conversational_coach.py
sys = SystemMessage(content=(
    "הנחיה 1: אל תעשה X\n"
    "הנחיה 2: אל תעשה Y\n"
    "הנחיה 3: אל תעשה Z\n"
    # ... 200 שורות של "אל תעשה" ...
    "הנחיה 127: תדבר כמו צבי מהספר (5 שורות)"
))
```

### התוצאה:
- ❌ המאמן נשמע רובוטי ושאלוני
- ❌ ה-LLM רואה "ים של הנחיות" וטיפה של דוגמאות
- ❌ אין סקרנות אמיתית
- ❌ המשתמש מרגיש כאילו ממלא שאלון

---

## 💡 הפתרון - Few-Shot Learning

### העיקרון:
**לימוד על ידי דוגמאות, לא הנחיות!**

במקום לתת 200 שורות של "אל תעשה", נתן **8-10 דוגמאות אמיתיות** מהספר של איך צבי מדבר עם דוד.

### למה זה עובד?
LLMs לומדים **הרבה יותר טוב** מדוגמאות (few-shot) מאשר מהנחיות (instructions).

זה כמו ללמד ילד:
- ❌ **הנחיות**: "אל תדבר בצורה פורמלית, אל תשתמש במילים ארוכות, אל תשאל שתי שאלות..."
- ✅ **דוגמאות**: הראה לו איך אמא שלו מדברת עם אבא - הוא ילמד מהדוגמה!

---

## 🏗️ הארכיטקטורה החדשה

### קובץ חדש: `few_shot_examples.py`

```python
FEW_SHOT_EXAMPLES_HE = """
=== דוגמאות שיחה אמיתיות מהספר ===

דוגמה 1 - נושא:
דוד: "על הורות"
צבי: "אוקיי, הורות. ספר לי על רגע אחד לאחרונה..."

דוגמה 2 - רגשות:
דוד: "כעס, תסכול"
צבי: "כעס ותסכול. רגשות מציפים אותנו באשכולות, אפשר עוד רגש אחד?"

דוגמה 3 - עמדה (רווח והפסד):
צבי: "מה אתה מרוויח מהעמדה הזו? ומה אולי אתה מפסיד?"

=== שים לב לסגנון ===
✓ פשוט וישיר
✓ סקרנות אמיתית
✓ אין אמוג'י
✓ חמימות אנושית
"""
```

### המבנה החדש של `conversational_coach.py`:

```
1. Few-Shot Examples (50%)    ← הדוגמאות מהספר
   └─ 8-10 דיאלוגים אמיתיים
   
2. Critical Principles (20%)   ← רק הכרחי!
   ├─ שאלה אחת בפעם
   ├─ אל תחזור אחורה
   ├─ שקף, אל תפרש
   └─ רגעים פגיעים
   
3. Stage Context (10%)         ← מה-RAG
   └─ דוגמאות ספציפיות לשלב
   
4. Gender Adaptation (10%)     ← אם צריך
   
5. Context Summary (10%)       ← מה קרה עד עכשיו
```

---

## 📊 השוואה: לפני ואחרי

### **לפני (200 שורות הנחיות):**

```
System Prompt:
- Line 1-30: Identity & Vocabulary
- Line 31-60: Critical Principles
- Line 61-90: What NOT to do
- Line 91-120: More what NOT to do
- Line 121-150: Even more what NOT to do
- Line 151-180: Forbidden phrases
- Line 181-200: Tone instructions
- Line 201-205: [דוגמאות מהספר - 5 שורות בסוף!]

Total: 200 lines, 95% instructions, 5% examples
```

**תוצאה:** רובוט שאלוני

---

### **אחרי (Few-Shot First):**

```
System Prompt:
- Line 1-50: דוגמאות אמיתיות מהספר (8 דיאלוגים)
- Line 51-80: עקרונות קריטיים בלבד (ONE QUESTION, NEVER GO BACKWARDS)
- Line 81-90: Stage context מה-RAG
- Line 91-100: Gender + Context

Total: 100 lines, 50% examples, 30% principles, 20% context
```

**תוצאה:** מאמן שמדבר כמו צבי!

---

## 🎨 דוגמאות מהשינוי

### **דוגמה 1: נושא "הורות"**

**לפני (עם 200 שורות הנחיות):**
```
User: "על הורות"
Coach: "זה תחום רחב! 🎯 מה בתוך זה הכי מעניין אותך להתאמן עליו עכשיו?"
```

**אחרי (עם few-shot):**
```
User: "על הורות"
Coach: "אוקיי, הורות. ספר לי על רגע אחד לאחרונה שהרגשת משהו חזק בקשר לזה."
```

---

### **דוגמה 2: רגשות**

**לפני:**
```
User: "כעס, תסכול"
Coach: "אני שומע שהרגשת כעס ותסכול. האם היו עוד רגשות?"
```

**אחרי (למד מהדוגמה "רגשות מציפים אותנו באשכולות"):**
```
User: "כעס, תסכול"
Coach: "כעס ותסכול. אפשר עוד רגש אחד?"
```

---

### **דוגמה 3: עמדה**

**לפני:**
```
User: "אני מאמין שאני צריך לשלוט"
Coach: "זה מעניין. ספר לי יותר על האמונה הזו."
```

**אחרי (למד מהדוגמה "רווח והפסד"):**
```
User: "אני מאמין שאני צריך לשלוט"
Coach: "בוא נסתכל על זה. מה אתה מרוויח מהעמדה הזו? ומה אולי אתה מפסיד?"
```

---

## 🚀 יתרונות הגישה החדשה

### 1. **למידה טבעית**
- LLM לומד מדוגמאות, לא מהנחיות
- קל יותר לו "לתפוס" את הסגנון

### 2. **פחות רעש**
- 200 שורות → 100 שורות
- 50% דוגמאות, 50% הנחיות (במקום 5% דוגמאות, 95% הנחיות)

### 3. **סגנון עקבי**
- כל הדוגמאות מתוך אותו ספר
- סגנון אחיד של צבי המאמן

### 4. **קל לתחזוקה**
- רוצה לשנות סגנון? שנה דוגמה אחת
- לא צריך לערוך 200 שורות של הנחיות

### 5. **ניתן להרחבה**
- אפשר להוסיף דוגמאות ספציפיות לכל שלב
- אפשר לשנות דוגמאות לפי נושא המשתמש (עתידי)

---

## 📝 קבצים שהשתנו

### 1. **`backend/app/bsd/few_shot_examples.py`** ✨ NEW
- מכיל 8 דוגמאות דיאלוג אמיתיות
- עברית ואנגלית
- מבוסס על הספר "סודות האימון היהודי"

### 2. **`backend/app/bsd/conversational_coach.py`** 🔄 MAJOR REFACTOR
- **לפני**: 200 שורות system prompt
- **אחרי**: 100 שורות (50% דוגמאות, 50% עקרונות)
- Few-shot examples **ראשון**, הנחיות **שני**

### 3. **`backend/app/bsd/talker.py`** 🔧 UPDATED
- הסרת חסימות על S1
- `conversational_coach` עכשיו משמש ל-**כל** שלבי S1
- הסרת hard-coded responses

### 4. **`backend/app/bsd/router_s1.py`** 🔧 UPDATED
- סובלנות לטעויות כתיב ("הורוות" → "הורות")
- GOAL_NOT_TOPIC יותר סלחן ("אבא מוביל" = TOPIC_CLEAR)

---

## 🧪 בדיקות שעשינו

### Test 1: Stage Context Injection
```bash
python test_stage_context.py
```
**תוצאה:** ✅ S1, S3, S8 - כולם מקבלים context מהספר

### Test 2: Typo Tolerance
```bash
python -m app.bsd.test_typo_tolerance
```
**תוצאה:** ✅ "הורוות" → מתוקן ל-"הורות" ומקובל

### Test 3: Response Quality
```bash
python simple_test.py
```
**תוצאה:** 
- ✅ אין אמוג'י
- ✅ אין "זה רחב"
- ✅ שפה טבעית ("אוקיי", "ספר")

---

## 🔮 עתידי (אופציונלי)

### 1. **Dynamic Few-Shot per Topic**
למשוך דוגמאות **רלוונטיות לנושא**:
- משתמש מדבר על "הורות" → דוגמאות על הורות
- משתמש מדבר על "עבודה" → דוגמאות על עבודה

### 2. **Few-Shot per Stage**
דוגמאות שונות לכל שלב:
- S1 (נושא) - דוגמאות של קבלת נושא
- S3 (רגשות) - דוגמאות של חילוץ רגשות
- S8 (עמדה) - דוגמאות של רווח והפסד

### 3. **User Feedback Loop**
- אסוף feedback: "האם התשובה הרגישה טבעית?"
- שפר דוגמאות לפי feedback

### 4. **A/B Testing**
- 50% משתמשים - few-shot prompt
- 50% משתמשים - old prompt
- השווה סיפוק משתמשים

---

## 📚 מקורות השראה

- **"סודות האימון היהודי"** - בני גל
- **Few-Shot Learning** - GPT-3 Paper (Brown et al., 2020)
- **Prompt Engineering Best Practices** - OpenAI Cookbook

---

## ✅ סיכום

### מה עשינו:
1. ✨ יצרנו `few_shot_examples.py` עם דוגמאות אמיתיות
2. 🔄 שינינו `conversational_coach.py` - **Few-Shot First!**
3. 📉 הקטנו הנחיות מ-200 ל-100 שורות
4. 📈 הגדלנו דוגמאות מ-5% ל-50% מהפרומפט
5. 🧪 בדקנו שהכל עובד

### התוצאה:
**מאמן שמדבר כמו צבי, לא רובוט!** 🎉

---

**תאריך:** 2026-02-01  
**סטטוס:** ✅ הושלם ומוכן לטסט

